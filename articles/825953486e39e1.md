---
title: "sqlalchemy orm ã¨ Eager Loading"
emoji: "ğŸ’¨"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: []
published: false
---

ã¯ã„ã€æ‰¿çŸ¥ã„ãŸã—ã¾ã—ãŸã€‚

ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ `sqlalchemy.exc.InvalidRequestError: The unique() method must be invoked on this Result, as it contains results that include joined eager loads against collections` ã¯ã€SQLAlchemy ã® ORM ã§ç™ºç”Ÿã™ã‚‹å…¸å‹çš„ãªã‚¨ãƒ©ãƒ¼ã®ä¸€ã¤ã§ã€ç‰¹ã«ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ã® Eager Loadingï¼ˆç©æ¥µçš„èª­ã¿è¾¼ã¿ï¼‰ã¨çµæœã‚»ãƒƒãƒˆã®é‡è¤‡ã«é–¢é€£ã—ã¦ã„ã¾ã™ã€‚

**ã‚¨ãƒ©ãƒ¼ã®åŸå› ã¨ SQLAlchemy ã® ORM ãƒ†ãƒ¼ãƒ–ãƒ«çµåˆãƒ»Eager Loading ã«ã¤ã„ã¦**

1.  **Eager Loading ã¨ã¯**:

    - SQLAlchemy ã§ã¯ã€ã‚ã‚‹ãƒ¢ãƒ‡ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—ã™ã‚‹éš›ã«ã€ãã‚Œã«é–¢é€£ã™ã‚‹åˆ¥ã®ãƒ¢ãƒ‡ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ï¼‰ã‚‚åŒæ™‚ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å–å¾—ã™ã‚‹æ–¹æ³•ã¨ã—ã¦ Eager Loading ãŒã‚ã‚Šã¾ã™ã€‚
    - ä¾‹ãˆã°ã€`SupportPlanCycle` ã‚’å–å¾—ã™ã‚‹éš›ã«ã€ãã‚Œã«é–¢é€£ã™ã‚‹ `SupportPlanStatus` ã®ãƒªã‚¹ãƒˆã‚„ `PlanDeliverable` ã®ãƒªã‚¹ãƒˆã‚‚ä¸€åº¦ã®ã‚¯ã‚¨ãƒªï¼ˆã¾ãŸã¯æœ€å°é™ã®ã‚¯ã‚¨ãƒªï¼‰ã§å–å¾—ã—ã‚ˆã†ã¨ã—ã¾ã™ã€‚
    - ã“ã‚Œã¯ã€å€‹åˆ¥ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—ã—ãŸå¾Œã«ã€é–¢é€£ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå¿…è¦ã«ãªã‚‹ãŸã³ã«éƒ½åº¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ï¼ˆLazy Loadingï¼‰ã‚ˆã‚Šã‚‚åŠ¹ç‡ãŒè‰¯ã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
    - Eager Loading ã¯ã€`joinedload`ã€`selectinload`ã€`subqueryload` ãªã©ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ã£ã¦æŒ‡å®šã—ã¾ã™ã€‚

2.  **`joinedload` ã¨é‡è¤‡**:

    - `joinedload` ã¯ã€ä¸»ã¨ãªã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆä¾‹: `support_plan_cycle`ï¼‰ã¨é–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆä¾‹: `support_plan_status`ï¼‰ã‚’ SQL ã® `JOIN` ã‚’ä½¿ã£ã¦çµåˆã—ã€ä¸€åº¦ã«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã™ã€‚
    - ä¸»ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ 1 ã¤ã«å¯¾ã—ã¦ã€é–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒè¤‡æ•°å­˜åœ¨ã™ã‚‹å ´åˆï¼ˆä¾‹: 1 ã¤ã®ã‚µã‚¤ã‚¯ãƒ«ã«è¤‡æ•°ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼‰ã€`JOIN` ã®çµæœã¨ã—ã¦ä¸»ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒé‡è¤‡ã—ã¦è¿”ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
      - ä¾‹: Cycle A ã« Status X ã¨ Status Y ãŒã‚ã‚‹å ´åˆã€JOIN ã®çµæœã¯ (Cycle A, Status X) ã¨ (Cycle A, Status Y) ã® 2 è¡Œã«ãªã‚Šã¾ã™ã€‚

3.  **`InvalidRequestError` ã®ç™ºç”Ÿ**:

    - SQLAlchemy ãŒ `JOIN` ã«ã‚ˆã£ã¦é‡è¤‡ã—ãŸä¸»ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å«ã‚€çµæœã‚»ãƒƒãƒˆã‚’å—ã‘å–ã£ãŸéš›ã€ãã®ã¾ã¾ã§ã¯ Python ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦æ­£ã—ããƒãƒƒãƒ”ãƒ³ã‚°ã§ããªã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
    - ç‰¹ã«ã€ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãƒªã‚¹ãƒˆãªã©ï¼‰ã¸ã®ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ã‚’ `joinedload` ã—ã¦ã„ã‚‹å ´åˆã€ã“ã®é‡è¤‡ãŒç™ºç”Ÿã—ã‚„ã™ããªã‚Šã¾ã™ã€‚
    - ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã‚ã‚‹ã‚ˆã†ã«ã€ã“ã®ã‚ˆã†ãªé‡è¤‡ã‚’å«ã‚€å¯èƒ½æ€§ã®ã‚ã‚‹çµæœã‚»ãƒƒãƒˆã«å¯¾ã—ã¦ `.scalars().all()` ã‚„ `.all()` ã‚’ç›´æ¥å‘¼ã³å‡ºã™ã¨ã€SQLAlchemy ã¯ã“ã®ã‚¨ãƒ©ãƒ¼ã‚’ç™ºç”Ÿã•ã›ã€ã€ŒçµæœãŒä¸€æ„ã«ãªã‚‹ã‚ˆã†ã« `.unique()` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã™å¿…è¦ãŒã‚ã‚‹ã€ã¨æŒ‡ç¤ºã—ã¾ã™ã€‚

4.  **`.unique()` ãƒ¡ã‚½ãƒƒãƒ‰**:
    - `.unique()` ã¯ã€SQLAlchemy ãŒçµæœã‚»ãƒƒãƒˆã‚’å‡¦ç†ã™ã‚‹éš›ã«ã€é‡è¤‡ã™ã‚‹ä¸»ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã€å„ä¸»ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¯¾ã—ã¦é–¢é€£ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæ­£ã—ãç´ä»˜ã‘ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
    - `JOIN` ã«ã‚ˆã£ã¦ç”Ÿã˜ãŸé‡è¤‡è¡Œã‹ã‚‰ã€ä¸€æ„ãªä¸»ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒªã‚¹ãƒˆã‚’æ§‹ç¯‰ã—ã€ãã‚Œãã‚Œã®ä¸»ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ï¼ˆä¾‹: `cycle.statuses`ï¼‰ã«æ­£ã—ãé–¢é€£ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ ¼ç´ã—ã¾ã™ã€‚

**ä»Šå›ã®ã‚¨ãƒ©ãƒ¼ç®‡æ‰€**

`test_crud_get_multi_by_recipient_with_details_single_cycle_no_related_data` ãƒ†ã‚¹ãƒˆå†…ã®ä»¥ä¸‹ã®éƒ¨åˆ†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚

```python
# test_crud_support_plan_cycle.py ã®è©²å½“ç®‡æ‰€
cycles = await support_plan_cycle.get_multi_by_recipient( # ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã‚‹
    db=async_db_session, recipient_id=test_service_recipient_for_crud.id
)
```

ãã—ã¦ã€`crud_support_plan.py` ã® `get_multi_by_recipient` ãƒ¡ã‚½ãƒƒãƒ‰ã®å®Ÿè£…ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

```python
# crud_support_plan.py ã® get_multi_by_recipient ãƒ¡ã‚½ãƒƒãƒ‰
async def get_multi_by_recipient(
    self, db: AsyncSession, *, recipient_id: UUID, skip: int = 0, limit: int = 100
) -> List[SupportPlanCycle]:
    stmt = (
        select(self.model)
        .where(self.model.service_recipient_id == recipient_id)
        .order_by(desc(self.model.cycle_count))
        .offset(skip)
        .limit(limit)
        .options(
            joinedload(self.model.statuses), # ã“ã“ã§ statuses ã‚’ joinedload
            joinedload(self.model.deliverables) # ã“ã“ã§ deliverables ã‚’ joinedload
        )
    )
    result = await db.execute(stmt)
    return result.scalars().all() # â˜…ã‚¨ãƒ©ãƒ¼ã®åŸå› ç®‡æ‰€
```

`joinedload(self.model.statuses)` ã¨ `joinedload(self.model.deliverables)` ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€`SupportPlanCycle` 1 ä»¶ã«å¯¾ã—ã¦è¤‡æ•°ã® `SupportPlanStatus` ã‚„ `PlanDeliverable` ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€çµæœã‚»ãƒƒãƒˆã« `SupportPlanCycle` ã®é‡è¤‡ãŒç”Ÿã˜ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®é‡è¤‡ã—ãŸçµæœã«å¯¾ã—ã¦ `.scalars().all()` ã‚’ç›´æ¥å‘¼ã³å‡ºã—ã¦ã„ã‚‹ãŸã‚ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚

**ä¿®æ­£æ–¹æ³•**

`crud_support_plan.py` ã® `get_multi_by_recipient` ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§ã€`result.scalars().all()` ã®å‰ã« `.unique()` ã‚’å‘¼ã³å‡ºã™ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã™ã€‚

ä»¥ä¸‹ã®é€šã‚Šã€`keikakun_api/app/crud/crud_support_plan.py` ã‚’ä¿®æ­£ã—ã¾ã™ã€‚

`keikakun_api/app/crud/crud_support_plan.py` å†…ã® `get_multi_by_recipient` ãƒ¡ã‚½ãƒƒãƒ‰ã€ãŠã‚ˆã³åŒæ§˜ã« `joinedload` ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹ `get_with_details` ã¨ `get_latest_cycle_for_recipient` ãƒ¡ã‚½ãƒƒãƒ‰ã§ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ã®çµæœã‚’å‡¦ç†ã™ã‚‹éš›ã« `.unique()` ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚

ã“ã‚Œã«ã‚ˆã‚Šã€`joinedload` ã«ã‚ˆã£ã¦ç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹é‡è¤‡ã—ãŸä¸»ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæ­£ã—ãå‡¦ç†ã•ã‚Œã€`InvalidRequestError` ãŒè§£æ¶ˆã•ã‚Œã‚‹ã¯ãšã§ã™ã€‚

å†åº¦ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦çµæœã‚’ã”ç¢ºèªãã ã•ã„ã€‚ç‰¹ã« `test_crud_get_multi_by_recipient_with_details_single_cycle_no_related_data` ã®ã‚¨ãƒ©ãƒ¼ãŒè§£æ¶ˆã•ã‚Œã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚
